<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
  </head>
  <body>
    <a id="aa"></a>
    <a id="bb"></a>
    <a id="cc"></a>
    <script>
      var nylon = require('.');

      var option = {
        namespace: '::<Ethernet>',
        dissectors: [
          {
            namespaces: [
              '::<Ethernet>',
              /::<Ethernet>/
            ],
            script: __dirname + '/script/eth.es'
          }
        ],
        stream_dissectors: [
          {
            namespaces: [
              '::Ethernet::TCP',
              /::Ethernet::TCP/
            ],
            script: __dirname + '/script/str.es'
          }
        ]
      };

      var msgpack = require('msgpack-lite');
      var readStream = require('fs').createReadStream("dump.msgpack");
      var decodeStream = msgpack.createDecodeStream();

      nylon.Session.create(option).then((sess) => {
        readStream.pipe(decodeStream).on("data", function(data) {
          if (data.length === 4) {
            var pkt = {
              ts_sec: data[0],
              ts_nsec: data[1],
              length: data[2],
              payload: data[3]
            };
            sess.analyze(pkt);
          }
        });
        sess.filter('pkt', '(function(pkt) { return pkt.payload.slice(0, 101).length > 100 })');
        sess.filter('pkt2', '{');

        sess.on('packets', (stat) => {
          console.log(stat);
          console.log(sess.get(1));
          document.getElementById("aa").appendChild(document.createTextNode(sess.namespace));
        })
        sess.on('filter', (name, packets) => {
          console.log(name);
          console.log(packets);
          document.getElementById("bb").appendChild(document.createTextNode(sess.namespace));
        })
        sess.on('error', (err) => {
          console.log(err);
          document.getElementById("cc").appendChild(document.createTextNode(sess.namespace));
        })
      });
    </script>
  </body>
</html>
